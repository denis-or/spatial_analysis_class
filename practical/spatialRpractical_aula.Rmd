---
title: day 1 practical session, spatial data in R
---

You'll need the new version of the mapmisc package
```{r installMapmics}
# install.packages("mapmisc", 
# 	repos="http://r-forge.r-project.org")
```

```{r packages}
library('mapmisc')
library(tidyverse)
```

# A nice map

consider the following code.

```{r patrick}
mycoords <- rbind(
  c(-43.24373760113078, -22.874830195070757),
  c(-43.226769072563165, -22.912309778466696)
)

patrick <- vect(
  mycoords, 
  atts = data.frame(name = c('Work', 'Home')),
  crs = "EPSG:4674"  # SIRGAS 2000 (geográfico)
)

patrick |> sf::st_as_sf() |> ggplot() + geom_sf()

patrick_proj <- project(patrick, "EPSG:31983")

theMap <- openmap(
  x = patrick_proj,
  # path = "cartodb",
  buffer = 100 * c(50, 50, 50, 50)  # 50km cada lado
)

map.new(theMap)
plot(theMap, add = TRUE)
plot(
  patrick_proj,
  add = TRUE,
  col = "blue",
  pch = 20,
  cex = 2
)
mapmisc::scaleBar(crs(patrick_proj), "topleft", bg = "white")

forInset <- openmap(patrick_proj, 
  buffer=50*1000
)

# map.new(forInset)
# plot(forInset, add = TRUE)
mapmisc::insetMap(
  crs = crs(patrick_proj),
  pos = "topright",
  map = forInset,
  inset = 0,
  width = 0.2
)

```


It makes a map showing where I lived during my PhD years, and the location of Lancaster University.

- Choose two locations important to you, such as the location of your first primary school and where you lived at the time. 
- Find their coordinates, using google maps or openstreetmap.org
- make a map similar to mine.
- use the `text` function to label the points



# Make a map involving polygons

Use your dataset of interest to make a map involving polygons.  Or if you prefer do the following.

On the web site [sites.wustl.edu/acag/datasets/surface-pm2-5/#V6.GL.02.04](https://sites.wustl.edu/acag/datasets/surface-pm2-5/#V6.GL.02.04) there are images of particulate matter concentrations worldwide.  I downloaded the 2020 global image from [wustl.app.box.com/s/y143mciw7jz7ft2qe3hccjw65m3xe8f2/folder/327753085334](https://wustl.app.box.com/s/y143mciw7jz7ft2qe3hccjw65m3xe8f2/folder/327753085334), saved it in my Downloads folder and 

```{r data}
x <- rast("data/V6GL02.04.CNNPM25.GL.202001-202012.nc")

brazil <- project(geodata::gadm("BRA", level = 1, path = "data"), crs(x))
# brazil_lim <- project(geodata::gadm("BRA", level = 0, path = "data"), crs(x))
brazil_lim <- geobr::read_country(simplified = TRUE) |> 
  sf::st_transform(crs(x))


plot(brazil_lim)

xCrop <- crop(x, brazil_lim, mask=TRUE)
xCrop[xCrop<= 0] <- NA

plot(xCrop)

myCol = mapmisc::colourScale(
  xCrop,
  breaks = 5,
  style = 'equal',
  col = 'RdYlGn',
  rev = TRUE,
  transform = 'sqrt',
  dec = 0
)

map.new(xCrop)
plot(
  xCrop,
  col = myCol$col,
  breaks = myCol$breaks,
  legend = FALSE,
  add = TRUE
)
plot(brazil, add = TRUE, border = 'white')
plot(brazil_lim, add = TRUE, border = 'black')
legendBreaks('bottomright', myCol)
```

- Find the average PM by municipality in Brazil.  How does Rio rank?
- Look at the help files for geodata::world.  Use it to create a similar map of all south america.

```{r}
brazil_mun <- geobr::read_municipality() |> sf::st_transform(crs(x))

brazil_mun_avg <- extract(xCrop, brazil_mun, fun = mean, na.rm = TRUE)

brazil_mun <- brazil_mun |> 
  dplyr::mutate(
    mean_PM = brazil_mun_avg[,2],
    rank = rank(-mean_PM, na.last = "keep")
  )

ggplot() +
  geom_sf(data = brazil_mun, aes(fill = mean_PM), color = "transparent") +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Average PM2.5 by Municipality in Brazil",
       fill = "PM2.5 (µg/m³)") +
  theme(legend.position = "bottom")

# How does Rio rank?
brazil_mun |> 
  dplyr::filter(name_muni == "Rio De Janeiro") |>
  dplyr::pull(rank)


```

# Mapping a raster

Make a map of a raster related to your project.  Or if you prefer use one of the datasets from the following web sites measure nighttime light using satelites.  

- https://gee-community-catalog.org/projects/hntl/
- https://figshare.com/articles/dataset/Harmonization_of_DMSP_and_VIIRS_nighttime_light_data_from_1992-2018_at_the_global_scale/9828827/5

- Choose an interesting part of the planet (your hometown? North Korea? Tierra del Fuego?) and plot the lights image.  
- put one or two interesting cities or places on the map





